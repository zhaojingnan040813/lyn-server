# 生产环境部署问题排查与解决方案

## 问题描述

容器启动后健康检查失败，报错：

```
Readiness probe failed: dial tcp 10.40.18.209:3000: connect: connection refused
Liveness probe failed: dial tcp 10.40.18.209:3000: connect: connection refused
```

## 根本原因

应用启动时需要连接 MongoDB 数据库，但**生产环境缺少必要的环境变量**，导致：

1. 数据库连接失败
2. 应用无法正常启动
3. 3000 端口未能成功监听
4. 健康检查探针连接失败

## 解决方案

### 1. 配置环境变量（**必须**）

在微信云托管控制台配置以下环境变量：

#### 必需的环境变量：

```bash
# 数据库配置（必须）
MONGODB_URI=mongodb://你的数据库地址:端口
DB_NAME=diet_recommendation

# API配置（必须）
DEEPSEEK_API_KEY=sk-你的API密钥

# 服务器配置
PORT=3000
NODE_ENV=production

# 跨域配置
CORS_ORIGIN=https://你的前端域名
```

#### 可选的环境变量：

```bash
# DeepSeek 配置
DEEPSEEK_BASE_URL=https://api.deepseek.com
DEEPSEEK_MODEL=deepseek-reasoner
DEEPSEEK_MAX_TOKENS=8192
DEEPSEEK_ENABLE_JSON_OUTPUT=true
DEEPSEEK_JSON_OUTPUT_MODEL=deepseek-chat
```

### 2. 数据库连接选项

#### 选项 A：使用云数据库（推荐）

使用腾讯云 MongoDB：

```bash
MONGODB_URI=mongodb://用户名:密码@数据库地址:端口/数据库名?authSource=admin
```

#### 选项 B：使用外部数据库

如果使用 Sealos 等其他云平台的数据库：

```bash
MONGODB_URI=mongodb://root:密码@dbconn.sealoshzh.site:端口/?directConnection=true
```

### 3. 已优化的 Dockerfile 配置

已将健康检查启动等待时间从 5 秒增加到 60 秒：

```dockerfile
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3
```

这样可以给应用足够的时间来：

- 连接数据库
- 初始化资源
- 启动 HTTP 服务器

### 4. 微信云托管配置步骤

1. **登录微信云托管控制台**

   - 进入你的服务管理页面

2. **配置环境变量**

   - 点击"版本配置"或"环境变量"
   - 添加上述必需的环境变量
   - **注意**：环境变量不会显示在日志中，请妥善保管

3. **调整健康检查配置**（如果可以配置）

   - 启动延迟：60 秒
   - 检查间隔：30 秒
   - 超时时间：10 秒
   - 失败阈值：3 次

4. **重新部署服务**
   - 配置完环境变量后，重新部署或重启服务

## 验证步骤

部署完成后，检查以下内容：

### 1. 查看容器日志

应该能看到成功启动的日志：

```
╔═══════════════════════════════════════════════════════════╗
║                                                           ║
║   🍽️  智能体质膳食推荐系统 API 服务已启动                  ║
║                                                           ║
║   📍 服务地址: http://localhost:3000                      ║
║   📚 API文档: http://localhost:3000/api-docs             ║
║   🏥 健康检查: http://localhost:3000/health              ║
║   🌍 环境: production                                    ║
║                                                           ║
╚═══════════════════════════════════════════════════════════╝
```

### 2. 测试健康检查端点

```bash
curl http://你的服务地址/health
```

应该返回：

```json
{
  "status": "ok",
  "timestamp": "2025-12-18T14:00:00.000Z",
  "environment": "production"
}
```

### 3. 测试 API 文档

访问：`http://你的服务地址/api-docs`
应该能看到 Swagger API 文档界面

## 常见问题

### Q1: 还是连接失败怎么办？

检查：

1. 环境变量是否正确配置
2. MongoDB URI 格式是否正确
3. 数据库是否可以从云托管环境访问
4. DeepSeek API Key 是否有效

### Q2: 如何查看详细的错误日志？

在微信云托管控制台：

1. 进入服务详情
2. 点击"日志"或"运行日志"
3. 查看应用启动时的错误信息

### Q3: 数据库连接超时怎么办？

可能是网络问题：

1. 确认数据库白名单配置
2. 检查数据库是否支持外网访问
3. 考虑使用同一云平台的数据库服务

### Q4: 如何测试数据库连接？

可以临时修改 [src/app.js](src/app.js#L79-L82)，添加更详细的错误日志：

```javascript
catch (error) {
    console.error('❌ Failed to start server:', error);
    console.error('错误详情:', error.message);
    console.error('MongoDB URI:', config.mongodb.uri);
    process.exit(1);
}
```

## 下一步

配置完环境变量后：

1. 重新部署服务
2. 等待 60-90 秒让应用完全启动
3. 检查服务状态
4. 测试 API 接口

## 安全建议

1. **不要将 .env 文件提交到 Git**
   - 已在 `.gitignore` 中配置
2. **使用环境变量管理敏感信息**

   - API Key
   - 数据库密码
   - 其他凭证

3. **定期轮换密钥**

   - 定期更换 API Key
   - 定期更改数据库密码

4. **限制数据库访问**
   - 只允许必要的 IP 访问
   - 使用强密码

## 参考资料

- [微信云托管文档](https://cloud.weixin.qq.com/cloudrun/document)
- [Docker 健康检查最佳实践](https://docs.docker.com/engine/reference/builder/#healthcheck)
- [Node.js 生产环境最佳实践](https://nodejs.org/en/docs/guides/nodejs-docker-webapp)
